generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  createdAt DateTime @default(now())

  sessions          Session[]
  conversations     Conversation[]
  knowledgeItems    KnowledgeItem[] @relation("submittedBy")
  approvedItems     KnowledgeItem[] @relation("approvedBy")
  auditLogs         AuditLog[]
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model Conversation {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String    @default("Untitled")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  messages Message[]
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  role           String       @default("user") // user | assistant
  content        String
  createdAt      DateTime     @default(now())
}

model KnowledgeItem {
  id                String   @id @default(cuid())
  layer             String   // LEGAL | FIRM | CLIENT
  scopeType         String   @default("GLOBAL") // GLOBAL | CLIENT
  scopeClientId     String?  // only for CLIENT scope
  title             String
  slug              String
  contentText       String
  language          String   @default("EN") // AF | EN | MIXED
  tags              String   @default("[]") // JSON array
  primaryDomain     String   @default("OTHER") // VAT | INCOME_TAX | COMPANY_TAX | PAYROLL | CAPITAL_GAINS_TAX | WITHHOLDING_TAX | ACCOUNTING_GENERAL | OTHER
  secondaryDomains  String   @default("[]") // JSON array of domain strings
  status            String   @default("PENDING") // PENDING | APPROVED | REJECTED
  kbVersion         Int      @default(1)
  citationId        String   @unique // KB:LEGAL:slug:v1
  supersededById    String?  // nullable FK to newer version
  sourceType        String?  // "user" | "website" | null (for manual submissions)
  sourceUrl         String?  // URL if sourceType=website
  sourceSection     String?  // heading/section where content came from
  submittedByUserId String?
  submittedBy       User?    @relation("submittedBy", fields: [submittedByUserId], references: [id], onDelete: SetNull)
  approvedByUserId  String?
  approvedBy        User?    @relation("approvedBy", fields: [approvedByUserId], references: [id], onDelete: SetNull)
  approvedAt        DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([status])
  @@index([layer])
  @@index([scopeType])
  @@index([slug])
  @@index([primaryDomain])
  @@index([sourceType])
}

model AuditLog {
  id          String   @id @default(cuid())
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  actionType  String   // LOGIN | LOGOUT | MESSAGE_SEND | KB_SUBMIT | KB_APPROVE | KB_REJECT | REASON_QUERY
  entityType  String? // Conversation | Message | KnowledgeItem | None
  entityId    String?
  detailsJson String? // JSON string with additional details
  createdAt   DateTime @default(now())

  @@index([actionType])
  @@index([userId])
  @@index([createdAt])
}
